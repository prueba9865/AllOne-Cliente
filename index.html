<!DOCTYPE html>
<html>

<head>
    <title>Slide Navbar</title>
    <link rel="stylesheet" type="text/css" href="css/styles_index.css">
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500&display=swap" rel="stylesheet">
    <!-- Iconos de Google Fonts -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
    <div id="mensaje" class="mensaje"></div>
    <div class="main">
        <input type="checkbox" id="chk" aria-hidden="true">

        <!-- Formulario de registro -->
        <div class="signup">
            <form id="registerForm">
                <label for="chk" aria-hidden="true">Sign up</label>
                <input type="text" name="nombre" placeholder="Nombre">
                <input type="email" name="email" placeholder="Email">
                <input type="text" name="username" placeholder="Username">
                <input type="password" name="password" placeholder="Contraseña">
                <input type="password" name="password2" placeholder="Repetir Contraseña">
                <button type="submit">Sign up</button>
            </form>
        </div>

        <!-- Formulario de login -->
        <div class="login">
            <form id="loginForm">
                <label for="chk" aria-hidden="true">Login</label>
                <input type="text" name="username" placeholder="Usuario">
                <input type="password" name="password" placeholder="Contraseña">
                <button type="submit">Login</button>

                <!-- Botón de Google -->
                <button class="google-btn" type="button" onclick="loginWithGoogle()">
                    <img src="img/google.webp" alt="Google Logo">
                    <span>Iniciar sesión con Google</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // Función para enviar el formulario de registro
        document.getElementById('registerForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Evitar que el formulario se envíe automáticamente

            // Obtener los datos del formulario
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            // Enviar los datos al endpoint de registro
            fetch('http://localhost:8080/api/v1/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(response => {
                    if (!response.ok) {
                        // Si la respuesta no es exitosa, verificar si es un error 400
                        return response.json().then(errorData => {
                            throw errorData; // Lanzar los errores para manejarlos en el catch
                        });
                    }
                    return response.json(); // Si la respuesta es exitosa, devolver los datos
                })
                .then(data => {
                    console.log('Registro exitoso:', data);
                    mostrarMensaje('Registro exitoso', 'exito');
                    // Redirigir al usuario o realizar otras acciones
                })
                .catch(errorData => {
                    console.error('Error en el registro:', errorData);
                    if (errorData.nombre) {
                        // Si hay un mensaje de error en data.password, mostrarlo
                        mostrarMensaje(errorData.nombre, 'error');
                    } else if (errorData.email) {
                        mostrarMensaje(errorData.email, 'error');
                    } else if (errorData.username) {
                        mostrarMensaje(errorData.username, 'error');
                    } else if (errorData.password) {
                        mostrarMensaje(errorData.password, 'error');
                    } else if (errorData.password2) {
                        mostrarMensaje(errorData.password2, 'error');
                    } else if (errorData.error) {
                        mostrarMensaje(errorData.error, 'error');
                    } else {
                        // Mostrar un mensaje genérico de error
                        mostrarMensaje('Error en el registro', 'error');
                    }
                });
        });

        // Función para enviar el formulario de login
        document.getElementById('loginForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Evitar que el formulario se envíe automáticamente

            // Obtener los datos del formulario
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            // Enviar los datos al endpoint de login
            fetch('http://localhost:8080/api/v1/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(response => {
                    if (!response.ok) {
                        // Si la respuesta no es exitosa, verificar si es un error 400
                        return response.json().then(errorData => {
                            throw errorData; // Lanzar los errores para manejarlos en el catch
                        });
                    }
                    return response.json(); // Si la respuesta es exitosa, devolver los datos
                })
                .then(data => {
                    console.log('Login exitoso:', data);
                    // Redirigir al usuario o realizar otras acciones
                    document.cookie = `token=${data.token}; path=/; max-age=86400`; // Expira en 1 dia
                    window.location.href = "home.html"
                })
                .catch(errorData => {
                    console.error('Error en el registro:', errorData);
                    if (errorData.message) {
                        // Si hay un mensaje de error en data.password, mostrarlo
                        mostrarMensaje(errorData.message, 'error');
                    } else {
                        // Mostrar un mensaje genérico de error
                        mostrarMensaje('Error en el login', 'error');
                    }
                });
        });

        // Función para simular el inicio de sesión con Google
        function loginWithGoogle() {
            window.location.href = "http://localhost:8080/oauth2/authorization/google";
        }

        function mostrarMensaje(mensaje, tipo) {
            const contenedorMensaje = document.getElementById("mensaje");
            contenedorMensaje.textContent = mensaje;
            contenedorMensaje.className = `mensaje ${tipo}`; // Aplica la clase de estilo
            contenedorMensaje.style.display = "block"; // Muestra el mensaje

            // Opcional: Ocultar el mensaje después de unos segundos
            setTimeout(() => {
                contenedorMensaje.style.display = "none";
            }, 5000); // 5 segundos
        }
    </script>
</body>

</html>