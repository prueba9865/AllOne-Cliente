<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Completo</title>
    <link rel="stylesheet" href="css/styles_home.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Fondo oscuro (se mostrará cuando el popup esté activo) -->
    <div id="overlay"></div>

    <!-- Avatar circular en esquina superior derecha -->
    <div class="profile-avatar" id="profileAvatar">
        <div class="profile-dropdown" id="profileDropdown">
            <a href="/profile"><i class="fas fa-user"></i> Mi perfil</a>
            <a href="/settings"><i class="fas fa-cog"></i> Configuración</a>
            <a href="/logout" class="logout"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a>
        </div>
    </div>

    <!-- Popup de solicitudes -->
    <div class="requests-popup" id="requestsPopup">
        <div class="popup-content">
            <div class="popup-header">
                <h3>Solicitudes de amistad</h3>
                <button class="close-popup" id="closeRequestsPopup">&times;</button>
            </div>
            <div class="requests-list" id="requestsList">
                <!-- Las solicitudes se cargarán aquí -->
            </div>
        </div>
    </div>

    <!-- Botón para agregar gente -->
    <div class="add-people-btn" id="addPeopleBtn">
        <i class="fas fa-user-plus"></i>
    </div>

    <!-- Popup de búsqueda -->
    <div class="search-popup" id="searchPopup">
        <div id="mensaje" class="mensaje"></div>
        <div class="popup-content">
            <div class="popup-header">
                <h3>Agregar nuevo contacto</h3>
                <button class="close-popup" id="closePopup">&times;</button>
            </div>
            <div class="search-container">
                <div class="search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="userSearchInput" placeholder="Buscar..." class="search-input">
                </div>
                <div class="search-results" id="userSearchResults"></div>
            </div>
        </div>
    </div>


    <div class="tabs">
        <button class="tab-button" data-tab="reels">Reels</button>
        <button class="tab-button active" data-tab="chat">Chat</button>
        <button class="tab-button" data-tab="ai">IA</button>
    </div>
    <div class="dashboard">
        <!-- Sección de Reels -->
        <div class="section reels-section" style="display: none;">
            <h2>Reels</h2>
            <div class="reels-container">
                <div class="reel-item">
                    <img src="https://picsum.photos/200/350" alt="Reel 1">
                    <div class="reel-info">
                        <span class="views">10.5K views</span>
                        <span class="duration">0:30</span>
                    </div>
                </div>
                <div class="reel-item">
                    <img src="https://picsum.photos/200/351" alt="Reel 2">
                    <div class="reel-info">
                        <span class="views">8.2K views</span>
                        <span class="duration">0:45</span>
                    </div>
                </div>
                <div class="reel-item">
                    <img src="https://picsum.photos/200/352" alt="Reel 3">
                    <div class="reel-info">
                        <span class="views">15K views</span>
                        <span class="duration">1:00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Chat -->
        <div class="section chat-section active">
            <!-- Vista de lista de chats -->
            <div class="chat-list-view active">
                <h2>Chats</h2>
                <div class="chat-list-full" id="chatList">
                    <!-- Los chats se cargarán dinámicamente -->
                </div>
            </div>

            <!-- Vista de chat individual -->
            <div class="chat-detail-view">
                <div class="chat-header">
                    <button class="back-button" onclick="showChatList()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img src="https://picsum.photos/40/40" alt="Profile" class="profile-pic">
                    <span class="chat-name">Selecciona un chat</span>
                </div>
                <div class="messages" id="messages"></div>
                <div class="input-area">
                    <input type="text" id="messageInput" placeholder="Escribe un mensaje...">
                    <button onclick="sendMessage()">Enviar</button>
                </div>
            </div>
        </div>

        <!-- Sección de IA -->
        <div class="section ai-section" style="display: none;">
            <h2>Asistente IA</h2>
            <div class="ai-container">
                <div class="ai-messages" id="aiMessages">
                    <div class="ai-message received">
                        ¡Hola! Soy tu asistente IA. ¿En qué puedo ayudarte?
                    </div>
                </div>
                <div class="ai-input-area">
                    <textarea id="aiPrompt" placeholder="Escribe tu pregunta aquí..."></textarea>
                    <button onclick="sendAIPrompt()">Preguntar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Icono de notificaciones (nuevo) -->
    <div class="notification-bell" id="notificationBell">
        <i class="fas fa-bell"></i>
        <span class="notification-count" id="notificationCount">0</span>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos del popup
            const addPeopleBtn = document.getElementById('addPeopleBtn');
            const searchPopup = document.getElementById('searchPopup');
            const closePopup = document.getElementById('closePopup');
            const userSearchInput = document.getElementById('userSearchInput');
            const userSearchResults = document.getElementById('userSearchResults');

            // Mostrar popup
            addPeopleBtn.addEventListener('click', () => {
                searchPopup.classList.add('active');
            });

            // Ocultar popup
            closePopup.addEventListener('click', () => {
                searchPopup.classList.remove('active');
            });

            let searchTimeout;

            userSearchInput.addEventListener('input', function (e) {
                const query = e.target.value.trim();
                clearTimeout(searchTimeout); // Cancela el timeout anterior

                if (query.length > 0) {
                    searchTimeout = setTimeout(() => {
                        searchUsers(query);
                    }, 300); // Espera 300ms después de la última tecla
                } else {
                    userSearchResults.innerHTML = '';
                }
            });

            // Función que busca usuarios en el backend
            function searchUsers(query) {
                fetch("http://localhost:8080/usuarios")
                    .then(response => {
                        if (!response.ok) throw new Error("Error al cargar usuarios");
                        return response.json();
                    })
                    .then(users => {
                        // Filtrar para no mostrar al usuario actual
                        const filteredUsers = users.filter(user =>
                            user.id !== currentUserId && (
                                user.name.toLowerCase().includes(query.toLowerCase()) ||
                                user.username.toLowerCase().includes(query.toLowerCase())
                            )
                        );
                        displaySearchResults(filteredUsers);
                    })
                    .catch(error => {
                        console.error("Error en la búsqueda:", error);
                        userSearchResults.innerHTML = '<div class="no-results">Error al buscar usuarios</div>';
                    });
            }

            function displaySearchResults(users) {
                userSearchResults.innerHTML = '';

                if (users.length === 0) {
                    userSearchResults.innerHTML = '<div class="no-results">No se encontraron usuarios</div>';
                    return;
                }

                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    userCard.innerHTML = `
                        <img src="${user.avatar}" alt="${user.name}" class="user-avatar">
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-username">@${user.username}</div>
                        </div>
                        <button class="add-btn" data-user-id="${user.id}">Agregar</button>
                    `;

                    // Lógica para agregar usuario
                    userCard.querySelector('.add-btn').addEventListener('click', async (e) => {
                        const userId = e.target.getAttribute('data-user-id');
                        try {
                            const response = await fetch(`http://localhost:8080/usuarios/1/agregar-contacto/${userId}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });

                            if (response.ok) {
                                mostrarMensaje("Solicitud de amistad enviada", "exito")
                            } else {
                                mostrarMensaje("Error al enviar solicitud", "error")
                            }
                        } catch (error) {
                            console.error("Error:", error);
                        }
                        /*e.stopPropagation();
                        console.log('Usuario agregado:', user.id);
                        // Aquí iría tu lógica para agregar el usuario
                        mostrarMensaje("Solicitud de amistad enviada", "exito")*/
                    });

                    userSearchResults.appendChild(userCard);
                });
            }

            // Cerrar popup al hacer clic fuera
            searchPopup.addEventListener('click', (e) => {
                if (e.target === searchPopup) {
                    searchPopup.classList.remove('active');
                }
            });

            // Estilo para "no hay resultados"
            const style = document.createElement('style');
            style.textContent = `
                .no-results {
                    padding: 20px;
                    text-align: center;
                    color: #6b7280;
                }
            `;
            document.head.appendChild(style);

            const profileAvatar = document.getElementById('profileAvatar');
            const profileDropdown = document.getElementById('profileDropdown');
            const logoutButton = profileDropdown.querySelector('a.logout');

            // Variables globales
            let menuTimeout;
            const menuHoverDelay = 200; // ms de retraso para cerrar

            // Configuración de eventos
            profileAvatar.addEventListener('mouseenter', () => {
                clearTimeout(menuTimeout);
                profileDropdown.classList.add('show-dropdown');
            });

            profileAvatar.addEventListener('mouseleave', () => {
                menuTimeout = setTimeout(() => {
                    if (!profileDropdown.matches(':hover')) {
                        profileDropdown.classList.remove('show-dropdown');
                    }
                }, menuHoverDelay);
            });

            profileDropdown.addEventListener('mouseenter', () => {
                clearTimeout(menuTimeout);
            });

            profileDropdown.addEventListener('mouseleave', () => {
                menuTimeout = setTimeout(() => {
                    profileDropdown.classList.remove('show-dropdown');
                }, menuHoverDelay);
            });

            // Evento click para dispositivos táctiles
            profileAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('show-dropdown');
            });

            // Cierre al hacer click fuera
            document.addEventListener('click', (e) => {
                if (!profileAvatar.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('show-dropdown');
                }
            });

            logoutButton.addEventListener('click', function (e) {
                e.preventDefault(); // Evita que siga el href
                handleLogout(); // Llama a la función
            });

            const token = getCookie("token");

            if (!token) {
                console.error("No se encontró el token en cookies");
                // Imagen por defecto si no hay avatar
                profileAvatar.style.backgroundImage = 'url(https://www.gravatar.com/avatar/default?s=200)';
                profileAvatar.style.backgroundColor = getRandomColor();
                return;
            }

            fetch("http://localhost:8080/decode-jwt", {
                method: "GET",
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Cache-Control': 'no-cache',
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text) });
                    }
                    return response.json();
                })
                .then(data => {
                    // Asignar el id del usuario a la variable global
                    window.currentUserId = data.id;
                    loadFriendRequests(); // Carga inicial
                    setInterval(loadFriendRequests, 30000); // Refresco periódico
                    console.log("El avatar es: " + data.avatar);
                    if (data.avatar) {
                        profileAvatar.style.backgroundImage = `url(${data.avatar})`;
                    } else {
                        profileAvatar.style.backgroundImage = 'url(https://www.gravatar.com/avatar/default?s=200)';
                        profileAvatar.style.backgroundColor = getRandomColor();
                    }
                    // Una vez obtenido el ID, se pueden cargar las solicitudes pendientes
                    loadFriendRequests();
                    // Inicia el intervalo para refrescar las solicitudes, si lo deseas
                    setInterval(loadFriendRequests, 30000);
                })
                .catch(error => {
                    console.error("Error en la petición:", error);
                    if (error.message.includes("401")) window.location.href = "/index.html";
                });


        });

        // Función para obtener el valor de una cookie por nombre
        function getCookie(name) {
            const cookies = document.cookie.split('; ');
            for (const cookie of cookies) {
                const [cookieName, cookieValue] = cookie.split('=');
                if (cookieName === name) {
                    return decodeURIComponent(cookieValue); // Decodifica caracteres especiales
                }
            }
            return null; // Si no encuentra la cookie
        }

        // Función para manejar el logout
        function handleLogout() {
            // Elimina la cookie del token
            document.cookie = 'token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            // Redirige al login
            window.location.href = '/index.html';
        }

        function toggleAddUserPopup() {
            const popup = document.getElementById("addUserPopup");
            const overlay = document.getElementById("overlay");

            const isVisible = popup.style.display === "block";

            if (isVisible) {
                popup.style.display = "none";
                overlay.style.display = "none";
            } else {
                popup.style.display = "block";
                overlay.style.display = "block";
            }
        }

        function mostrarMensaje(mensaje, tipo) {
            const contenedorMensaje = document.getElementById("mensaje");
            contenedorMensaje.textContent = mensaje;
            contenedorMensaje.className = `mensaje ${tipo}`; // Aplica la clase de estilo
            contenedorMensaje.style.display = "block"; // Muestra el mensaje

            // Opcional: Ocultar el mensaje después de unos segundos
            setTimeout(() => {
                contenedorMensaje.style.display = "none";
            }, 5000); // 5 segundos
        }

        // ========== CÓDIGO MEJORADO PARA SOLICITUDES ========== //

        // Elementos del popup de solicitudes
        const notificationBell = document.getElementById('notificationBell');
        const notificationCount = document.getElementById('notificationCount');
        const requestsPopup = document.getElementById('requestsPopup');
        const closeRequestsPopup = document.getElementById('closeRequestsPopup');
        const requestsList = document.getElementById('requestsList');

        // Mostrar popup de solicitudes
        notificationBell.addEventListener('click', () => {
            if (!window.currentUserId) {
                console.error("ID de usuario no disponible");
                return;
            }
            requestsPopup.classList.add('active');
            loadFriendRequests();
        });

        // Cerrar popup
        closeRequestsPopup.addEventListener('click', () => {
            requestsPopup.classList.remove('active');
        });

        // Cargar solicitudes pendientes
        async function loadFriendRequests() {
            /*if (!window.currentUserId) {
                console.log("Esperando ID de usuario...");
                return;
            }*/

            try {
                const response = await fetch(`http://localhost:8080/usuarios/2/solicitudes-pendientes`);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const solicitudes = await response.json();
                console.log("Solicitudes recibidas:", solicitudes);

                updateNotificationCount(solicitudes.length);
                renderRequests(solicitudes);
            } catch (error) {
                console.error("Error al cargar solicitudes:", error);
                requestsList.innerHTML = '<div class="no-requests">Error al cargar solicitudes</div>';
            }
        }

        // Renderizar lista de solicitudes (versión mejorada)
        function renderRequests(solicitudes) {
            requestsList.innerHTML = '';

            if (!solicitudes || solicitudes.length === 0) {
                requestsList.innerHTML = '<div class="no-requests">No tienes solicitudes pendientes</div>';
                return;
            }

            solicitudes.forEach(solicitud => {
                const requestItem = document.createElement('div');
                requestItem.className = 'request-item';

                // Asegúrate que estos campos coinciden con tu respuesta del backend
                requestItem.innerHTML = `
            <img src="${solicitud.avatar || 'https://www.gravatar.com/avatar/default?s=200'}" 
                 class="user-avatar">
            <div class="user-info">
                <div class="user-name">${solicitud.name || solicitud.nombre || 'Usuario'}</div>
                <div class="user-username">@${solicitud.username || 'usuario'}</div>
            </div>
            <div class="request-actions">
                <button class="accept-btn" data-id="${solicitud.id || solicitud.solicitudId}">✓</button>
                <button class="reject-btn" data-id="${solicitud.id || solicitud.solicitudId}">✗</button>
            </div>
        `;

                // Manejar aceptar/rechazar
                requestItem.querySelector('.accept-btn').addEventListener('click', async (e) => {
                    const solicitudId = e.target.getAttribute('data-id');
                    await respondToRequest(solicitudId, true);
                });

                requestItem.querySelector('.reject-btn').addEventListener('click', async (e) => {
                    const solicitudId = e.target.getAttribute('data-id');
                    await respondToRequest(solicitudId, false);
                });

                requestsList.appendChild(requestItem);
            });
        }

        // Función mejorada para responder a solicitudes
        async function respondToRequest(solicitudId, aceptar) {
            try {
                const response = await fetch(`http://localhost:8080/solicitudes/${solicitudId}/responder?aceptar=${aceptar}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                mostrarMensaje(aceptar ? "¡Solicitud aceptada!" : "Solicitud rechazada", "exito");
                loadFriendRequests(); // Recargar lista

                // Actualizar lista de contactos si es necesario
                if (aceptar) {
                    // loadUserContacts(); // Si tienes esta función
                }
            } catch (error) {
                console.error("Error al responder solicitud:", error);
                mostrarMensaje("Error al procesar la solicitud", "error");
            }
        }

        // Actualizar contador de notificaciones
        function updateNotificationCount(count) {
            notificationCount.textContent = count;
            notificationCount.style.display = count > 0 ? 'flex' : 'none';

            // Animación para llamar la atención
            if (count > 0) {
                notificationBell.classList.add('has-notifications');
            } else {
                notificationBell.classList.remove('has-notifications');
            }
        }

        // Cerrar popup al hacer clic fuera
        requestsPopup.addEventListener('click', (e) => {
            if (e.target === requestsPopup) {
                requestsPopup.classList.remove('active');
            }
        });
    </script>
</body>

</html>